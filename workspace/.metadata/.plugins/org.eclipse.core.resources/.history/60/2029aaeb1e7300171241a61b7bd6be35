package SlideScan;

import java.awt.EventQueue;

import javax.swing.JFrame;
import javax.swing.JTabbedPane;

import org.micromanager.Studio;

import mmcorej.CMMCore;

import javax.swing.JButton;
import java.awt.event.ActionListener;
import java.awt.event.ActionEvent;
import javax.swing.JLabel;
import java.awt.Choice;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import java.io.File;

import javax.swing.JTextField;
import javax.swing.JPanel;
import java.awt.Label;
import javax.swing.JTextPane;
import javax.swing.JComboBox;
import javax.swing.JFileChooser;
import javax.swing.DefaultComboBoxModel;

public class SlideScanUI {

	private JFrame frmUcsfSlideScan;
	
	//Plugin attributes
	private Studio gui_;
	private CMMCore core_;
	private SlideScan scanCtr;
	private boolean isColorRGB;
	
	
    private double[] FOV = new double[2];
    private int[] A = new int[2];
    private int[] B  = new int[2];
    private int overlap = 15;
    private Thread scanWorker; 
    private JTextField textFOV_W;
    private JTextField textFOV_H;
    private JTextField textOverlap;
    private JTextField textImgFolder;
    private JTextField textPixRes;
    private JTextField textRed;
    private JTextField textGreen;
    private JTextField textBlue;
    private JLabel lblNumTiles;
    private JComboBox comboColorMode;

	/**
	 * Launch the application.
	 */
	public static void main(String[] args) {
		EventQueue.invokeLater(new Runnable() {
			public void run() {
				try {
					SlideScanUI window = new SlideScanUI();
					window.frmUcsfSlideScan.setVisible(true);
				} catch (Exception e) {
					e.printStackTrace();
				}
			}
		});
	}
	
	public SlideScanUI(Studio gui) throws Exception{
		gui_ = gui;
        try {
            core_ = gui_.getCMMCore();
        } catch (Exception ex) {
            throw new Exception("SlideScan plugin could not get MMCore");
        }
        //Init GUI
		initialize();
        getComboColorMode().setSelectedIndex(0); //always begin with GRY acquisition
        isColorRGB = false;
	}

	/**
	 * Create the application.
	 */
	public SlideScanUI() {
		initialize();
	}
	
	public JFrame getFrame() {
		return this.frmUcsfSlideScan;
	}
	
	public void setControler(SlideScan ctr) {
		scanCtr = ctr;
	}
	

	/**
	 * Initialize the contents of the frame.
	 */
	private void initialize() {
		frmUcsfSlideScan = new JFrame();
		frmUcsfSlideScan.setTitle("UCSF Slide Scan v0.01");
		frmUcsfSlideScan.setBounds(100, 100, 451, 403);
		frmUcsfSlideScan.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
		frmUcsfSlideScan.getContentPane().setLayout(null);
		
		JTabbedPane tabbedPane = new JTabbedPane(JTabbedPane.TOP);
		tabbedPane.setBounds(0, 11, 433, 354);
		frmUcsfSlideScan.getContentPane().add(tabbedPane);
		
		JPanel panelCamLens = new JPanel();
		tabbedPane.addTab("Camera/Lens", null, panelCamLens, null);
		panelCamLens.setLayout(null);
		
		JLabel lblLensFovmm = new JLabel("Lens FOV (mm):");
		lblLensFovmm.setBounds(66, 133, 105, 14);
		panelCamLens.add(lblLensFovmm);
		
		JLabel label_1 = new JLabel("W:");
		label_1.setBounds(181, 133, 14, 14);
		panelCamLens.add(label_1);
		
		textFOV_W = new JTextField();
		textFOV_W.setColumns(10);
		textFOV_W.setBounds(205, 130, 67, 20);
		panelCamLens.add(textFOV_W);
		
		JLabel label_2 = new JLabel("H:");
		label_2.setBounds(282, 133, 25, 14);
		panelCamLens.add(label_2);
		
		textFOV_H = new JTextField();
		textFOV_H.setColumns(10);
		textFOV_H.setBounds(294, 130, 67, 20);
		panelCamLens.add(textFOV_H);
		
		JLabel lblPixelResolutionmm = new JLabel("Pixel resolution (mm):");
		lblPixelResolutionmm.setBounds(66, 161, 155, 14);
		panelCamLens.add(lblPixelResolutionmm);
		
		textPixRes = new JTextField();
		textPixRes.setBounds(205, 158, 67, 20);
		panelCamLens.add(textPixRes);
		textPixRes.setColumns(10);
		
		JLabel lblColorMode = new JLabel("Color mode:");
		lblColorMode.setBounds(66, 204, 58, 14);
		panelCamLens.add(lblColorMode);
		
		JLabel lblRed = new JLabel("Red:");
		lblRed.setBounds(149, 235, 46, 14);
		panelCamLens.add(lblRed);
		
		JLabel lblGree = new JLabel("Green:");
		lblGree.setBounds(149, 260, 46, 14);
		panelCamLens.add(lblGree);
		
		textRed = new JTextField();
		textRed.setEnabled(false);
		textRed.setBounds(205, 232, 67, 20);
		panelCamLens.add(textRed);
		textRed.setColumns(10);
		
		textGreen = new JTextField();
		textGreen.setEnabled(false);
		textGreen.setBounds(205, 257, 67, 20);
		panelCamLens.add(textGreen);
		textGreen.setColumns(10);
		
		JLabel lblBlue = new JLabel("Blue:");
		lblBlue.setBounds(149, 285, 46, 14);
		panelCamLens.add(lblBlue);
		
		textBlue = new JTextField();
		textBlue.setEnabled(false);
		textBlue.setBounds(205, 282, 67, 20);
		panelCamLens.add(textBlue);
		textBlue.setColumns(10);
		
		JTextPane textCameraInfo = new JTextPane();
		textCameraInfo.setBounds(10, 11, 408, 96);
		panelCamLens.add(textCameraInfo);
		
		comboColorMode = new JComboBox();
		comboColorMode.addMouseListener(new MouseAdapter() {
			@Override
			public void mouseClicked(MouseEvent e) {
				int select = comboColorMode.getSelectedIndex();
				if(select == 0) {
					isColorRGB = false;
					textRed.setEnabled(false);
					textGreen.setEnabled(false);
					textBlue.setEnabled(false);
				}else if(select == 1) {
					isColorRGB = true;
					textRed.setEnabled(true);
					textGreen.setEnabled(true);
					textBlue.setEnabled(true);
				}
			}
		});
		comboColorMode.setModel(new DefaultComboBoxModel(new String[] {"GRY", "RGB"}));
		comboColorMode.setBounds(205, 201, 67, 20);
		panelCamLens.add(comboColorMode);
		
		JPanel panelAcquisition = new JPanel();
		tabbedPane.addTab("Acquisition", null, panelAcquisition, null);
		panelAcquisition.setLayout(null);
		
		JLabel label_3 = new JLabel("Overlap (%):");
		label_3.setBounds(29, 80, 67, 22);
		panelAcquisition.add(label_3);
		
		textOverlap = new JTextField();
		textOverlap.setColumns(10);
		textOverlap.setBounds(140, 81, 54, 20);
		panelAcquisition.add(textOverlap);
		
		final JLabel lblCoordsA = new JLabel("000");
		lblCoordsA.setBounds(140, 147, 122, 14);
		panelAcquisition.add(lblCoordsA);
		
		JButton btnSetA = new JButton("Set A");
		btnSetA.addMouseListener(new MouseAdapter() {
			@Override
			public void mouseClicked(MouseEvent e) {
				try {
					int A[] = scanCtr.setCoordsA();
					String pos = "X: " + A[0] + "Y: " + A[1];
					lblCoordsA.setText(pos);
				}catch(Exception ex) {
					ex.printStackTrace();
				}
			}
		});
		btnSetA.setBounds(29, 113, 89, 23);
		panelAcquisition.add(btnSetA);
		
		final JLabel lblCoordsB = new JLabel("000");
		lblCoordsB.setBounds(140, 164, 122, 14);
		panelAcquisition.add(lblCoordsB);
		
		JButton btnSetB = new JButton("Set B");
		btnSetB.addMouseListener(new MouseAdapter() {
			@Override
			public void mouseClicked(MouseEvent e) {
				try {
					int B[] = scanCtr.setCoordsB();
					String pos = "X: " + B[0] + "Y: " + B[1];
					lblCoordsB.setText(pos);
				}catch(Exception ex) {
					ex.printStackTrace();
				}
			}
		});
		btnSetB.setBounds(140, 113, 89, 23);
		panelAcquisition.add(btnSetB);
		
		JLabel label_4 = new JLabel("Upper left corner (A):");
		label_4.setBounds(29, 147, 111, 14);
		panelAcquisition.add(label_4);
		

		
		JLabel label_6 = new JLabel("Lower right corner (B):");
		label_6.setBounds(29, 164, 111, 14);
		panelAcquisition.add(label_6);
		

		
		JLabel label_8 = new JLabel("Estimated num. tiles:");
		label_8.setBounds(27, 213, 122, 14);
		panelAcquisition.add(label_8);
		
		lblNumTiles = new JLabel("...");
		lblNumTiles.setBounds(146, 213, 251, 14);
		panelAcquisition.add(lblNumTiles);
		
		JButton btnFindHome = new JButton("Find Home");
		btnFindHome.addMouseListener(new MouseAdapter() {
			@Override
			public void mouseClicked(MouseEvent e) {
				scanCtr.getStageController().findHome();
			}
		});
		btnFindHome.setBounds(308, 113, 89, 23);
		panelAcquisition.add(btnFindHome);
		
		JButton btnScan = new JButton("Scan");
		btnScan.addMouseListener(new MouseAdapter() {
			@Override
			public void mouseClicked(MouseEvent e) {
//				double FOV[] = new double[2];
//				FOV[0] = Double.parseDouble(textFOV_W.getText());
//				FOV[1] = Double.parseDouble(textFOV_H.getText());
//				String folder = textImgFolder.getText();
//				int over = Integer.parseInt(textOverlap.getText());
				
		    	double[] FOV = {18.78,15.37};
		    	int[] A = {-370340,486093};
		    	int[] B = {-271876,481792};
		    	int over = 15;
		    	scanCtr.setA(A[0],A[1]);
		    	scanCtr.setB(B[0],B[1]);
				String folder = "C:\\Users\\Maryana\\Desktop\\test_stitch\\tif2";
		    	
				scanCtr.acquireImages(FOV, over, folder);
			}
		});
		btnScan.setBounds(27, 269, 89, 46);
		panelAcquisition.add(btnScan);
		
		JButton btnCancel = new JButton("Cancel");
		btnCancel.setBounds(306, 269, 89, 46);
		panelAcquisition.add(btnCancel);
		
		JLabel lblImageFolder = new JLabel("Image folder:");
		lblImageFolder.setBounds(10, 26, 67, 14);
		panelAcquisition.add(lblImageFolder);
		
		textImgFolder = new JTextField();
		textImgFolder.setBounds(87, 23, 254, 20);
		panelAcquisition.add(textImgFolder);
		textImgFolder.setColumns(10);
		
		JButton btnNewButton = new JButton("Open...");
		btnNewButton.addMouseListener(new MouseAdapter() {
			@Override
			public void mouseClicked(MouseEvent e) {
				JFileChooser chooser = new JFileChooser();
				chooser.setDialogTitle("Choose destination directory.");
				chooser.setFileSelectionMode(JFileChooser.DIRECTORIES_ONLY);
				if(chooser.showOpenDialog(getFrame()) == JFileChooser.APPROVE_OPTION) {
					File folder = chooser.getSelectedFile();
					textImgFolder.setText(folder.getPath());
				}
			}
		});
		btnNewButton.setBounds(351, 22, 67, 23);
		panelAcquisition.add(btnNewButton);
	}
	
	public void setNumTiles(String str) {
		lblNumTiles.setText(str);
	}
	
	public String getDestFolder() {
		return textImgFolder.getText();
	}
	
	public void setWorker(Thread t) {
		scanWorker = t;
	}
	private JComboBox getComboColorMode() {
		return comboColorMode;
	}
}
