package SlideScan;

import java.util.logging.Level;
import java.util.logging.Logger;

import org.micromanager.MenuPlugin;
import org.micromanager.Studio;
import org.micromanager.data.Coords;
import org.micromanager.data.Datastore;
import org.micromanager.data.Image;
import org.scijava.plugin.Plugin;

import calibration.WBSettings;
import ij.IJ;
import ij.ImagePlus;
import ij.process.ImageProcessor;
import ij.process.ShortProcessor;

/**
 *
 * @author Maryana Alegro
 */
@Plugin(type = MenuPlugin.class)
public class SlideScan implements MenuPlugin {

    public static String menuName = "Large-Slide Scan";
    public static String tooltipDescription = "Controls the Large Slide Scanner";
    Studio studio_;
    private SlideScanUI mWindow_;
    private StageController stageCtr;
    private CameraController camCtr;
    private int A[] = new int[2];
    private int B[] = new int[2];
    private int[] WB = new int[3]; //white balance point in RGB 
    

    @Override
    public void setContext(Studio app) {
        studio_ = app;
    }

    @Override
    public String getSubMenu() {
        return "Device Control";
    }

    @Override
    public void onPluginSelected() {
        try {

            mWindow_ = new SlideScanUI(studio_);
            studio_.events().registerForEvents(mWindow_);
            stageCtr = new StageController(studio_,this);
            mWindow_.setControler(this);
            camCtr = new CameraController(studio_);
            if(mWindow_.isColorModeOn()) {
            	WBSettings wb = mWindow_.getWBInfo();
            	if(wb != null) {
            		camCtr.initColorMode(wb.getR(), wb.getG(), wb.getB());
            	}else {
            		System.out.println("There was a problem initializing the color mode.");
            	}
            }
            
            //stageHelper.resetStage();
            
        } catch (Exception e) {
            Logger.getLogger(SlideScanUI.class.getName()).log(Level.SEVERE, null, e);
            studio_.logs().showError(e);
        }
        //wbForm_.setVisible(true);
        mWindow_.getFrame().setVisible(true);
    }


    public StageController getStageController() {
    	return stageCtr;
    }
    
    
    @Override
    public String getName() {
        return menuName;
    }

    @Override
    public String getHelpText() {
        return "Controls the Large Slide Scanner";
    }

    @Override
    public String getVersion() {
        return "0.01";
    }

    @Override
    public String getCopyright() {
        return "(C) 2017 UCSF Grinberg Lab";
    }
    
    public void acquireImages(double[] FOV, int overlap, String folder)  {
    	//String folder = mWindow_.getDestFolder();
    	//stageHelper.runAcquisition(FOV, A, B, overlap, cameraHelper, folder);
    	Thread worker = new ScanWorker("Scanworker1",  FOV, A, B, overlap, folder);
    	mWindow_.setWorker(worker);
    	worker.start();
    }
    
    public void shotTestImage(String folder) {
    	camCtr.doTestShotRGB(folder);
    }
    
    public void setNumTiles(String str) {
    	mWindow_.setNumTiles(str);
    }
    
    public void setA(int x, int y) {
    	A[0] = x;
    	A[1] = y;
    }
    
    public void setB(int x, int y) {
    	B[0] = x;
    	B[1] = y;
    }
    
    public void setWB(int r, int g, int b) {
    	WB[0] = r;
    	WB[1] = g;
    	WB[2] = b;
    }
       
    public int[] setCoordsA() throws Exception {
    	int[]pos = stageCtr.getStagePos();
    	A[0] = pos[0];
    	A[1] = pos[1];
    	return A;
    }
    
    public int[] setCoordsB() throws Exception {
    	int[]pos = stageCtr.getStagePos();
    	B[0] = pos[0];
    	B[1] = pos[1];
    	return B;
    }
    
    public boolean isColorModeOn() {
    	return mWindow_.isColorModeOn();
    }
    
    
    //
    //image acquisition thread
    //
    private class ScanWorker extends Thread{
        private double[] FOV;
        private int[] A;
        private int[] B;
        private int overlap;    
        private String dest;
    	ScanWorker(String name,double[]FOV,int[]A,int[]B,int olap,String destFolder){
    		super(name);
    		this.FOV = FOV;
    		this.A = A;
    		this.B = B;
    		this.overlap = olap;
    		this.dest = destFolder; 		
    	}
    	public void run() {
    		stageCtr.runAcquisition(FOV, A, B, overlap,camCtr,dest,
    				mWindow_.shouldSaveRaw(),mWindow_.shouldSaveAuto(),mWindow_.shouldCorrectField());
    	}

    }

}
